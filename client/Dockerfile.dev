FROM node:12-alpine

# If we need to use node-gyp to build anything: https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md#node-gyp-alpine

# Install dependencies
RUN apk update && apk add --no-cache \
    bash \
    git

# Set working directory
ENV PROJECT_DIR /home/node
WORKDIR ${PROJECT_DIR}

# Set up node variables
ENV NODE_ENV development
# ENV NODE_PATH ${PROJECT_DIR}/client/node_modules/.bin

# Copy source directories
COPY --chown=node:node . ${WORKDIR}/client
# COPY --chown=node:node ../githooks ${WORKDIR}/githooks
# COPY --chown=node:node ../.git ${WORKDIR}/.git

# Create node_module mount point
RUN mkdir -p ${PROJECT_DIR}/client/node_modules \
  && chown node:node -R ${PROJECT_DIR}/client/node_modules \
  && chmod 777 -R ${PROJECT_DIR}/client/node_modules
VOLUME [ "${PROJECT_DIR}/client/node_modules" ]

# Create built files mount point
RUN mkdir -p ${PROJECT_DIR}/client/dist \
  && chown node:node -R ${PROJECT_DIR}/client/dist \
  && chmod 777 -R ${PROJECT_DIR}/client/dist
VOLUME [ "${PROJECT_DIR}/client/dist" ]

# Change current user to node (recommended)
USER node

# Expose port for webpack-dev-server
EXPOSE 8000
CMD ["/bin/bash"]